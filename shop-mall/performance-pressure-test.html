<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>十、性能压测 - ZhangYao&#039;s Blog</title><meta description="【摘要】压力测试考察当前软硬件环境下所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数"><meta property="og:type" content="blog"><meta property="og:title" content="十、性能压测"><meta property="og:url" content="http://www.aizhangyao.com/shop-mall/performance-pressure-test.html"><meta property="og:site_name" content="ZhangYao&#039;s Blog"><meta property="og:description" content="【摘要】压力测试考察当前软硬件环境下所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/4.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/5.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/7.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/6.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/9.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/10.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/11.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/12.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/13.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/14.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/15.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/16.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/17.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/18.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/19.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/20.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/21.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/22.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/23.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/24.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/25.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/26.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/27.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/28.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/29.png"><meta property="og:image" content="http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/30.png"><meta property="article:published_time" content="2020-09-24T20:42:23.000Z"><meta property="article:modified_time" content="2020-10-26T13:08:04.670Z"><meta property="article:author" content="ZhangYao"><meta property="article:tag" content="ShopMall"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/gallery/images/shop-mall/performance-pressure-test/4.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.aizhangyao.com/shop-mall/performance-pressure-test.html"},"headline":"ZhangYao's Blog","image":["http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/4.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/5.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/7.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/6.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/9.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/10.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/11.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/12.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/13.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/14.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/15.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/16.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/17.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/18.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/19.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/20.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/21.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/22.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/23.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/24.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/25.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/26.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/27.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/28.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/29.png","http://www.aizhangyao.com/gallery/images/shop-mall/performance-pressure-test/30.png"],"datePublished":"2020-09-24T20:42:23.000Z","dateModified":"2020-10-26T13:08:04.670Z","author":{"@type":"Person","name":"ZhangYao"},"description":"【摘要】压力测试考察当前软硬件环境下所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数"}</script><link rel="canonical" href="http://www.aizhangyao.com/shop-mall/performance-pressure-test.html"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ZhangYao&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/aizhangyao"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-09-24T20:42:23.000Z" title="2020-09-24T20:42:23.000Z">2020-09-24</time><span class="level-item"><a class="link-muted" href="/categories/ShopMall/">ShopMall</a></span><span class="level-item">14 分钟 读完 (大约 2142 个字)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">十、性能压测</h1><div class="content"><p>【摘要】压力测试考察当前软硬件环境下所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数</p>
<a id="more"></a>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h1 id="性能压测-压力测试-基本介绍"><a href="#性能压测-压力测试-基本介绍" class="headerlink" title="性能压测-压力测试-基本介绍"></a>性能压测-压力测试-基本介绍</h1><h2 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h2><h2 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h2><p>压力测试考察当前软硬件环境下所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数。</p>
<p>使用压力测试，我们有希望找到很多种用其他测试方式更难发现的错误。有两种错误类型是：<strong>内存泄露</strong>，<strong>并发与同步</strong>。</p>
<p>有效的压力测试系统将应用以下这些关键条件：<strong>重复</strong>、<strong>并发</strong>、<strong>量级</strong>、<strong>随机变化</strong>。</p>
<h3 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h3><ul>
<li><p>响应时间(Response Time:RT)</p>
<p>响应时间指用户从客户端发起一个请求开始，到客户端接收到从服务器端返回的响应结束，整个过程所消耗的时间。</p>
</li>
<li><p>HPS(Hits Per Second)：每秒点击次数，单位是次/秒。</p>
</li>
<li><p>TPS(Transaction Per Second)：系统每秒处理交易数，单位是笔/秒。</p>
</li>
<li><p>QPS(Query Per Second)：系统每秒处理查询次数，单位是笔/秒。</p>
</li>
<li><p>无论TPS、QPS、HPS，此指标是衡量系统处理能力非常重要的指标，越大越好。根据经验，一般情况下：</p>
<ul>
<li>金融行业：1000TPS~50000TPS，不包括互联网化的活动。</li>
<li>保险行业：100TPS~100000TPS，不包括互联网化的活动。</li>
<li>制造行业：10TPS~5000TPS。</li>
<li>互联网电子商务：10000TPS~1000000TPS。</li>
<li>互联网中型网站：1000TPS~50000TPS。</li>
<li>互联网小型网站：500TPS~10000TPS。</li>
</ul>
</li>
<li><p>最大响应时间(Max Response Time)  指用户发出请求或者指令到系统做出反应(响应)的最大时间。</p>
</li>
<li><p>最少响应时间(Mininum Response Time)  指用户发出请求或者指令到系统做出反应(响应)的最少时间。</p>
</li>
<li><p>90%响应时间(90% Response Time)  是指所有用户的响应时间进行排序，第90%的响应时间。</p>
</li>
<li><p>从外部看，性能测试主要关注如下三个指标：</p>
<ul>
<li>吞吐量：每秒种系统能够处理的请求数、任务数。</li>
<li>响应时间：服务处理一个请求或一个任务的耗时。</li>
<li>错误率：一批请求中结果出错的请求所占比例。</li>
</ul>
</li>
</ul>
<h1 id="性能压测-压力测试-Apache-JMeter安装使用"><a href="#性能压测-压力测试-Apache-JMeter安装使用" class="headerlink" title="性能压测-压力测试-Apache JMeter安装使用"></a>性能压测-压力测试-Apache JMeter安装使用</h1><h3 id="JMeter"><a href="#JMeter" class="headerlink" title="JMeter"></a>JMeter</h3><h4 id="JMeter安装"><a href="#JMeter安装" class="headerlink" title="JMeter安装"></a>JMeter安装</h4><p><a href="https://jmeter.apache.org/">https://jmeter.apache.org/</a></p>
<h4 id="JMeter压测示例"><a href="#JMeter压测示例" class="headerlink" title="JMeter压测示例"></a>JMeter压测示例</h4><p>1.添加线程组。2.添加HTTP请求。3.添加监听器。4.启动压测&amp;查看分析报告。</p>
<ul>
<li><p>创建测试计划</p>
</li>
<li><p>右击测试计划-&gt;添加-&gt;线程(用户)-&gt;线程组</p>
<p>设置线程数为200，Ranm-Up时间为1秒，循环次数为100。</p>
</li>
<li><p>右击线程组-&gt;添加-&gt;取样器-&gt;HTTP请求</p>
</li>
<li><p>右击线程组-&gt;添加-&gt;监听器-&gt;察看结果树、汇总报告、聚合报告、汇总图</p>
</li>
</ul>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/4.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/5.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/7.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/6.png" alt=""></p>
<blockquote>
<p>影响性能考虑点包括：</p>
<p>数据库、应用程序、中间件(tomcat、Nginx)、网络和操作系统等方面。</p>
<p>首先要考虑自己的应用属于<strong>CPU密集型</strong>何时<strong>IO密集型</strong>。</p>
</blockquote>
<h4 id="JMeter-Address-Already-in-use错误解决"><a href="#JMeter-Address-Already-in-use错误解决" class="headerlink" title="JMeter Address Already in use错误解决"></a>JMeter Address Already in use错误解决</h4><p>windows本身提供的端口访问机制的问题。</p>
<p>Windows提供给TCP/IP链接的端口为1024-5000，并且要四分钟来循环回收他们。就导致我们在短时间内跑大量的请求时将端口占满了。</p>
<ul>
<li>在<code>cmd</code>中，用<code>regedit</code>命令打开注册表。</li>
<li>在<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters</code>下：<ul>
<li>右击parameters，添加一个新的DWORD，名字为MaxUserPort。</li>
<li>然后双击MaxUserPort，输入数值数据为65534，基数选择十进制（如果是分布式运行的话，控制机器和负载机器都需要这样操作哦）</li>
</ul>
</li>
<li>修改配置完毕之后记得重启机器才生效。</li>
</ul>
<p><code>https://docs.microsoft.com/zh-cn/troubleshoot/windows-client/networking/connect-tcp-greater-than-5000-error-wsaenobufs-10055</code></p>
<p><code>TCPTimeWaitDelay：30</code></p>
<h1 id="性能压测-压力测试-JMeter在windows下地址占用bug解决"><a href="#性能压测-压力测试-JMeter在windows下地址占用bug解决" class="headerlink" title="性能压测-压力测试-JMeter在windows下地址占用bug解决"></a>性能压测-压力测试-JMeter在windows下地址占用bug解决</h1><p><img src="/gallery/images/shop-mall/performance-pressure-test/9.png" alt=""></p>
<h1 id="性能压测-性能监控-堆内存与垃圾回收"><a href="#性能压测-性能监控-堆内存与垃圾回收" class="headerlink" title="性能压测-性能监控-堆内存与垃圾回收"></a>性能压测-性能监控-堆内存与垃圾回收</h1><p><img src="/gallery/images/shop-mall/performance-pressure-test/10.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/11.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/12.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/13.png" alt=""></p>
<h1 id="性能压测-性能监控-jvisualvm使用"><a href="#性能压测-性能监控-jvisualvm使用" class="headerlink" title="性能压测-性能监控-jvisualvm使用"></a>性能压测-性能监控-jvisualvm使用</h1><h2 id="jconsole与jvisualvm"><a href="#jconsole与jvisualvm" class="headerlink" title="jconsole与jvisualvm"></a>jconsole与jvisualvm</h2><p>jdk的两个小工具jconsole、jvisualvm(升级版的jconsole)；通过命令行启动，可监控本地和远程应用。远程应用需要配置。</p>
<p>因为我的电脑上已经安装了java的环境，所以在控制台直接输入下面的命令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zhangyao@MacBookPro ~ % jconsole</span><br></pre></td></tr></table></figure>

<p>就会跳出如下界面。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/14.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/15.png" alt=""></p>
<p>推荐使用jvisualvm。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zhangyao@MacBookPro ~ % jvisualvm</span><br></pre></td></tr></table></figure>

<p><img src="/gallery/images/shop-mall/performance-pressure-test/16.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/17.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/18.png" alt=""></p>
<p>工具-&gt;插件</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/19.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/20.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/21.png" alt=""></p>
<h1 id="性能压测-优化-中间件对性能的影响"><a href="#性能压测-优化-中间件对性能的影响" class="headerlink" title="性能压测-优化-中间件对性能的影响"></a>性能压测-优化-中间件对性能的影响</h1><p>输入<code>zhelimall.com</code> 客户端-&gt;nginx-&gt;gateway-&gt;集群的商品服务-&gt;gateway-&gt;nginx-&gt;客户端。</p>
<p>这个过程请求经历了两个中间件分别是nginx和gateway。</p>
<table>
<thead>
<tr>
<th>压测内容</th>
<th>接口地址示例</th>
<th>压测线程数</th>
<th>吞吐量/sec</th>
<th>90%响应时间/ms</th>
<th>99%响应时间/ms</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Nginx</strong></td>
<td>192.168.60.105</td>
<td>50</td>
<td>433</td>
<td>105</td>
<td>640</td>
</tr>
<tr>
<td><strong>Gateway</strong></td>
<td>127.0.0.1:88</td>
<td>50</td>
<td>14143</td>
<td>5</td>
<td>9</td>
</tr>
<tr>
<td><strong>简单服务</strong></td>
<td>localhost:8000/hello</td>
<td>50</td>
<td>14546</td>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td><strong>首页一级菜单渲染</strong></td>
<td>localhost:8000/</td>
<td>50</td>
<td>614(db,thymelef)</td>
<td>89</td>
<td>139</td>
</tr>
<tr>
<td><strong>首页一级菜单渲染</strong>(开thymelef缓存)</td>
<td>localhost:8000/</td>
<td>50</td>
<td>814</td>
<td>62</td>
<td>94</td>
</tr>
<tr>
<td><strong>首页一级菜单渲染</strong>(开thymelef缓存、优化数据库、关日志)</td>
<td>localhost:8000/</td>
<td>50</td>
<td>1161.1</td>
<td>46</td>
<td>72</td>
</tr>
<tr>
<td><strong>三级分类数据获取</strong></td>
<td>127.0.0.1:8000/index/catalog.json</td>
<td>50</td>
<td>7.4(db)/12.4(加索引)</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td><strong>三级分类数据获取</strong>(优化业务)</td>
<td>127.0.0.1:8000/index/catalog.json</td>
<td>50</td>
<td>191</td>
<td>290</td>
<td>370</td>
</tr>
<tr>
<td><strong>三级分类数据获取</strong>(使用redis作为缓存)</td>
<td>127.0.0.1:8000/index/catalog.json</td>
<td>50</td>
<td>508</td>
<td>105</td>
<td>132</td>
</tr>
<tr>
<td><strong>首页全量数据获取</strong></td>
<td>127.0.0.1:8000/</td>
<td>50</td>
<td>22.6(静态资源)</td>
<td>2814</td>
<td>23920</td>
</tr>
<tr>
<td>Nginx+Gateway</td>
<td></td>
<td>50</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gateway+简单服务</td>
<td>localhost:88/hello</td>
<td>50</td>
<td>7014</td>
<td>11</td>
<td>25</td>
</tr>
<tr>
<td>全链路</td>
<td>zhelimall.com/hello</td>
<td>50</td>
<td>700</td>
<td>59</td>
<td>152</td>
</tr>
</tbody></table>
<ul>
<li>中间件越多，性能损失越大，大多都是损失在网络交互上了；</li>
<li>优化业务<ul>
<li>DB(MySQL优化)</li>
<li>模板的渲染速度(缓存)</li>
<li>静态资源</li>
</ul>
</li>
</ul>
<p>给数据库添加索引</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/22.png" alt=""></p>
<h1 id="性能压测-优化-简单优化吞吐量测试"><a href="#性能压测-优化-简单优化吞吐量测试" class="headerlink" title="性能压测-优化-简单优化吞吐量测试"></a>性能压测-优化-简单优化吞吐量测试</h1><h1 id="性能压测-优化-nginx动静分离"><a href="#性能压测-优化-nginx动静分离" class="headerlink" title="性能压测-优化-nginx动静分离"></a>性能压测-优化-nginx动静分离</h1><p>前面我们是把所有的静态资源<code>static/index/css</code>、<code>static/index/img</code>、<code>static/index/js</code>。都放在微服务的tomcat下，这样关静态请求就占用了tomcat的很多资源，导致吞吐量急剧的降低。为了解决这个问题就可以使用nginx进行动静分离。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/23.png" alt=""></p>
<p>把项目下的<code>static</code>文件夹搬到<code>nginx/html</code>下。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/24.png" alt=""></p>
<p>替换链接、script、图片的路径。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/25.png" alt=""></p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/26.png" alt=""></p>
<p>修改nginx的配置，之后重启nginx。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  zhelimall.com;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#static路径下的转到/usr/share/nginx/html</span></span><br><span class="line">    <span class="attribute">location</span> /static/ &#123;</span><br><span class="line">    	<span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">			<span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">			<span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">      <span class="attribute">proxy_pass</span>  http://zhelimall;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="性能压测-优化-模拟线上应用内存崩溃宕机情况"><a href="#性能压测-优化-模拟线上应用内存崩溃宕机情况" class="headerlink" title="性能压测-优化-模拟线上应用内存崩溃宕机情况"></a>性能压测-优化-模拟线上应用内存崩溃宕机情况</h1><p>调整商品服务运行内存<code>-Xmx50m</code>，然后使用200个压测线程数。</p>
<p>使用jvisualvm监控Java后台运行情况。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/27.png" alt=""></p>
<p>程序后台抛出很多异常。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/28.png" alt=""></p>
<p>在浏览器访问<code>zhelimall.com</code>发现服务已经不可用。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/29.png" alt=""></p>
<p>重新调整<code>-Xmx1024m -Xms1024m -Xmn512m</code>启动内存。</p>
<p><img src="/gallery/images/shop-mall/performance-pressure-test/30.png" alt=""></p>
<h1 id="性能压测-优化-优化三级分类数据获取"><a href="#性能压测-优化-优化三级分类数据获取" class="headerlink" title="性能压测-优化-优化三级分类数据获取"></a>性能压测-优化-优化三级分类数据获取</h1><p>三级分类数据获取速度慢主要原因是在业务端进行了太多次与数据库的交互。把启动内存调整为<code>-Xmx100m</code>。优化思路主要是：把多次查询数据库变成一次。先把三级分类一次性全部查出存放在list中，然后在对list进行操作。</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/ShopMall/">ShopMall</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=5ef7656a652f9d001303a427&amp;product=inline-share-buttons&amp;cms=sop" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-info donate"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/gallery/donate/alipay.jpg" alt="支付宝"></span></a><a class="button is-warning donate" onclick="document.getElementById(&#039;paypal-donate-form&#039;).submit()"><span class="icon is-small"><i class="fab fa-paypal"></i></span><span>Paypal</span></a><form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" rel="noopener" id="paypal-donate-form"><input type="hidden" name="cmd" value="_donations"><input type="hidden" name="business" value="zhangyao9707@163.com"><input type="hidden" name="currency_code" value="USD"></form><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/gallery/donate/wechat.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/shop-mall/cache-and-distributed-lock.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">十一、缓存和分布式锁</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/data-structure/dynamic-programming.html"><span class="level-item">动态规划算法入门</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.6.2/gitalk.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.6.2/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: '4ba6a3903a7f233079df12209e29f5d8',
            repo: 'aizhangyao.github.io',
            owner: 'aizhangyao',
            clientID: '872c6e0704b3561faaca',
            clientSecret: '218979ed7b4abf1e403c79184e02808978a42558',
            admin: ["aizhangyao"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: 'last',
            
            
            enableHotKey: true
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/avatar.jpg" alt="ZhangYao"></figure><p class="title is-size-4 is-block line-height-inherit">ZhangYao</p><p class="is-size-6 is-block">Java Programmer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">64</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">20</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/aizhangyao" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/aizhangyao"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#前言"><span class="mr-2">1</span><span>前言</span></a></li><li><a class="is-flex" href="#性能压测-压力测试-基本介绍"><span class="mr-2">2</span><span>性能压测-压力测试-基本介绍</span></a><ul class="menu-list"><li><a class="is-flex" href="#性能监控"><span class="mr-2">2.1</span><span>性能监控</span></a></li><li><a class="is-flex" href="#压力测试"><span class="mr-2">2.2</span><span>压力测试</span></a><ul class="menu-list"><li><a class="is-flex" href="#性能指标"><span class="mr-2">2.2.1</span><span>性能指标</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#性能压测-压力测试-Apache-JMeter安装使用"><span class="mr-2">3</span><span>性能压测-压力测试-Apache JMeter安装使用</span></a><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex" href="#JMeter-Address-Already-in-use错误解决"><span class="mr-2">3.1.1</span><span>JMeter Address Already in use错误解决</span></a></li></ul></ul></li><li><a class="is-flex" href="#性能压测-压力测试-JMeter在windows下地址占用bug解决"><span class="mr-2">4</span><span>性能压测-压力测试-JMeter在windows下地址占用bug解决</span></a></li><li><a class="is-flex" href="#性能压测-性能监控-堆内存与垃圾回收"><span class="mr-2">5</span><span>性能压测-性能监控-堆内存与垃圾回收</span></a></li><li><a class="is-flex" href="#性能压测-性能监控-jvisualvm使用"><span class="mr-2">6</span><span>性能压测-性能监控-jvisualvm使用</span></a><ul class="menu-list"><li><a class="is-flex" href="#jconsole与jvisualvm"><span class="mr-2">6.1</span><span>jconsole与jvisualvm</span></a></li></ul></li><li><a class="is-flex" href="#性能压测-优化-中间件对性能的影响"><span class="mr-2">7</span><span>性能压测-优化-中间件对性能的影响</span></a></li><li><a class="is-flex" href="#性能压测-优化-简单优化吞吐量测试"><span class="mr-2">8</span><span>性能压测-优化-简单优化吞吐量测试</span></a></li><li><a class="is-flex" href="#性能压测-优化-nginx动静分离"><span class="mr-2">9</span><span>性能压测-优化-nginx动静分离</span></a></li><li><a class="is-flex" href="#性能压测-优化-模拟线上应用内存崩溃宕机情况"><span class="mr-2">10</span><span>性能压测-优化-模拟线上应用内存崩溃宕机情况</span></a></li><li><a class="is-flex" href="#性能压测-优化-优化三级分类数据获取"><span class="mr-2">11</span><span>性能压测-优化-优化三级分类数据获取</span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div><p class="help">Subscribe to get the lastest update!</p></form></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Algorithm/"><span class="level-start"><span class="level-item">Algorithm</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Blog/"><span class="level-start"><span class="level-item">Blog</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Business/"><span class="level-start"><span class="level-item">Business</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/CataLog/"><span class="level-start"><span class="level-item">CataLog</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/DLMS/"><span class="level-start"><span class="level-item">DLMS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Hello-World/"><span class="level-start"><span class="level-item">Hello World</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JDBC/"><span class="level-start"><span class="level-item">JDBC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JavaSE/"><span class="level-start"><span class="level-item">JavaSE</span></span><span class="level-end"><span class="level-item tag">30</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/MarkDown/"><span class="level-start"><span class="level-item">MarkDown</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/ShopMall/"><span class="level-start"><span class="level-item">ShopMall</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="level-start"><span class="level-item">多线程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">数据结构</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%9D%82%E8%AE%B0/"><span class="level-start"><span class="level-item">杂记</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ZhangYao&#039;s Blog" height="28"></a><p class="size-small"><span>&copy; 2018 - 2020 ZhangYao</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span>©版权说明:本网站所有内容均收集于互联网或自己创作,方便于网友与自己学习交流,如有侵权,请留言,立即处理.</span><script type="text/javascript" src="https://v1.cnzz.com/z_stat.php?id=1279030921&amp;web_id=1279030921"></script><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://www.aizhangyao.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://s9.cnzz.com/z_stat.php?id=1279030921&amp;web_id=1279030921" async></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5ef7656a652f9d001303a427&amp;product=inline-share-buttons&amp;cms=sop" async="async"></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>